# JVM은 무엇이며 자바 코드는 어떻게 실행하는 것인가.

## 목표
자바 소스 파일(.java)을 JVM으로 실행하는 과정 이해하기.

## 학습할 것

- JVM이란 무엇인가
- 컴파일 하는 방법
- 실행하는 방법
- 바이트코드란 무엇인가
- JIT 컴파일러란 무엇이며 어떻게 동작하는가
- JVM 구성 요소
- JDK와 JRE의 차이

## JVM이란 무엇인가
운영체제는 자바 프로그램을 바로 실행할 수 없는데, 그 이유는 자바 프로그램은 완전한 기계어가 아닌, 중간 단계의 바이트코드이기 때문에 이것을 해석하고 실행할 수 있는 가상의 운영체제가 필요하다. 이것이 자바 가상 기계(JVM: Java Virtual Machine)이다.
즉, **자바 바이트코드를 실행하기 위한 가상의 기계**

> 바이트코드는 모든 JVM에서 동일한 실행 결과를 보장하지만, JVM은 운영체제에 종속적이다.

그 이유는 자바 프로그램을 각 운영체제가 이해하는 기계어로 번역해서 실행해야하는데 이 때 JVM은 운영체제에 맞게 설치되어야 한다.

## 바이트코드란 무엇인가

- #### Java Compiler

`Java Compiler`는 자바를 가지고 작성한 자바 소스 코드를 JVM이 이해할 수 있는 자바 바이트코드로 변환한다.
또한, 자바를 설치하면 javac.exe라는 실행 파일 형태로 설치된다.

- #### Java Bytecode

`Java Bytecode`란 JVM이 이해할 수 있는 언어로 변환된 자바 소스 코드를 의미한다.
자바 컴파일러에 의해 변환되는 코드의 명령어 크기가 1바이트라서 `자바 바이트코드`라고 불린다. 확장자는 `.class`
자바 바이트코드는 JVM만 있으면, 어디서든 실행 쌉가능.

### Java의 큰 장점

- 운영체제별로 프로그램을 실행하고 관리하는 방법이 다르기 때문에 별도로 개발해야하지만, 이 자바 프로그램을 중계하는 JVM을 두어 자바 프로그램이 여러 운영체제에서 동일한 실행 결과가 나오도록 설계한 것이다. 따라서 개발자는 운영체제와 상관없이 자바 프로그램을 개발할 수 있다.

> **"Write once, run anywhere."** (한번 작성하면 어디서든 실행된다.)

## 컴파일 및 실행하는 방법

![KakaoTalk_20210128_203328106](https://user-images.githubusercontent.com/55525868/106133155-39612580-61a8-11eb-8b6f-e0548d421853.jpg)

![캡처](https://user-images.githubusercontent.com/55525868/106133730-023f4400-61a9-11eb-9338-ce6244d2554f.PNG)

- 자바 프로그램은 확장자가 `.java`인 파일을 작성하는 것부터 시작된다. 이것을 `소스파일`이라고 하는데, 이 소스 파일을 `컴파일러(Compiler)`로 컴파일하면 확장자가 `.class`인 바이트코드 파일이 생성된다. 바이트코드 파일은 `JVM 구동 명령어(java.exe)`에 의해 JVM에서 해석되고 해당 운영체제에 맞게 기계어로 번역된다. 바이트코드는 하나지만, JVM에 의해 번역되는 기계어는 OS에 따라 달라진다.

- 먼저 JDK 설치
- Path 설정
- .java 텍스트 파일 생성

![캡처](https://user-images.githubusercontent.com/55525868/106135881-da9dab00-61ab-11eb-957d-5790ba6591a8.PNG)

이 파일을 `자바 소스 파일`이라고 한다.

- 간단하게 hello를 출력해주는 코드는 작성하고 이 파일을 컴파일러(javac.exe)로 컴파일해야 한다.

![캡처](https://user-images.githubusercontent.com/55525868/106136201-4e3fb800-61ac-11eb-9ef0-1f13cb1cafce.PNG)

위 사진처럼 컴파일이 성공하면 확장명이 .class인 바이트코드 파일이 생성된다.

- 이 바이트코드 파일은 완전한 기계어가 아니므로 단독으로 실행할 수 없고 JVM이 실행되어야 한다. JVM을 구동시키는 명령어는 `java.exe`이다. 아래 사진을 참고.

![캡처](https://user-images.githubusercontent.com/55525868/106137550-349f7000-61ae-11eb-8c2c-2c42b8e9843a.PNG)

## 여기서 중요한 점이 있다.

![캡처](https://user-images.githubusercontent.com/55525868/107211470-ee1d0180-6a48-11eb-840c-6e1f160d8f4b.PNG)

지금 자바 버전이 `1.8`이다.

![캡처](https://user-images.githubusercontent.com/55525868/107211726-4fdd6b80-6a49-11eb-8ac0-791964398f1a.PNG)

컴파일을 한 후에 `Hello.java`를 실행시켜 주면 `UnsupportedClassVersionError`라는 에러가 뜬다.
이것은 무엇을 의미하는 것일까?

이 에러의 뜻은 만약 상위 버전으로 컴파일을 하고 난 후에 하위 버전으로 자바를 실행시키면 위와 같은 `UnsupportedClassVersionError`라는 에러가 뜬다.

반대로 하위 버전에서 컴파일을 한 후 상위 버전에서 실행시키면 문제가 없다.

## 바이트코드 확인하기

![캡처](https://user-images.githubusercontent.com/55525868/107212574-7fd93e80-6a4a-11eb-956b-748ddaea1e59.PNG)

javap -c Hello.class

## JIT 컴파일러란 무엇이며 어떻게 동작하는가
위의 장점들로 자바는 매우 강력한 언어지만, 한 번의 컴파일링으로 실행 가능한 기계어가 만들어지지 않고 JVM에 의해 기계어로 번역되고 실행되는 단계를 하나 더 거쳐야하기 때문에 C나 C++ 같은 언어에 비해 상대적으로 실행 속도가 느리다는 단점을 가지고 있습니다.
하지만 기계어로 빠르게 변환해주는 JVM 내부의 최적화된 JIT 컴파일러를 통해 속도의 격차는 많이 줄어들고 있습니다.

### JIT 컴파일러
JIT 컴파일러(Just-In-Time Compiler)란 프로그램이 실행 중인 `런타임`에 실제 기계어로 변환해 주는 컴파일러를 의미한다.

- JIT 컴파일러는 즉시 또는 시간에 맞추어 코드를 컴파일한다.
- 성능을 개선하기 위해 JIT 컴파일러는 런타임에 적절한 바이트 코드 시퀀스를 기계어로 컴파일한다.

동적 번역(dynamic translation)이라고도 불리는 이 기법은 프로그램의 실행 속도를 향상시키기 위해 개발되었다.
즉, JIT 컴파일러는 자바 컴파일러가 생성한 자바 바이트코드를 런타임에 바로 기계어로 변환하는데 사용한다.

## JVM 구성 요소
총 4가지

1. 클래스 로더(class loader)
2. Runtime Data Area
3. Execution Engine
4. 가비지 컬렉터(Garbage Collector)

### Execution Engine (인터프리터, JIT 컴파일러가 있다.)
자바 컴파일러에 의해 변환된 자바 바이트코드를 읽고 해석하는 역할을 하는 것이 자바 인터프리터(Java Interpreter)이다.

Execution Engine은 `Class Loader`에 의해 메모리에 적재된 바이트코드들을 기계로 변경해 명령어를 실행시켜주는 엔진이다.  
Execution Engine에는 `자바 인터프리터`와 `JIT 컴파일러`가 존재한다.

> 처음에느 자바 인터프리터를 수행하다가 일정 수준이 넘어가면 JIT 컴파일러가 실행된다.

### 클래스 로더
자바 소스 파일을 컴파일하면 `.class`인 바이트코드가 생성되는데 이것들을 묶어서 Runtime Data Area에 적재하는 것이 바로 `클래스 로더`이다.

### 가비지 컬렉터
JVM은 가비지 컬렉터(Garbage Collector)를 이용하여 더는 사용하지 않는 메모리를 자동으로 회수해준다.
따라서 개발자가 따로 메모리를 관리하지 않아도 되므로, 더욱 쉽게 프로그래밍에 집중할 수 있게 도와준다.

### Runtime Data Area
`Runtime Data Area`는 JVM이 OS로부터 할당받은 메모리 영역인데, 크게 메서드 영역, 스택 영역, 힙 영역이 있다.

- 메서드 영역: JVM이 읽어 들인 클래스, 인터페이스에 대한 런타임 상수 풀, 멤버 변수, 클래스 변수, 생성자와 메서드를 저장하는 공간
- 스택 영역: 각 스레드마다 하나씩 존재, 스레드가 시작될 때 할당. 프리미티브 타입이 저장된다.
- 힙 영역: JVM이 관리하는 프로그램 상에서 데이터를 저장하기 위해 런타임 시 동적으로 할당하여 사용하는 영역. New 연산자로 객체 또는 배열을 저장한다.

## JDK와 JRE의 차이
쉽게 말해서

- JDK = JRE + @
- JRE는 읽기 전용, JDK는 읽기/쓰기 전용

`JDK`는 *프로그램 개발*에 필요한 JVM, API, Compiler 등의 *개발 도구*가 포함되어 있고,
`JRE`는 *프로그램 실행*에 필요한 JVM, API 만 포함되어 있다.
즉, 자바 프로그램을 개발하고자 한다면 JDK를, 자바 프로그램을 실행시키고자 한다면 JRE만 설치하면 된다.

보통은 JDK를 설치하겠죠??

### reference
http://tcpschool.com/java/java_intro_programming
https://medium.com/@lazysoul/jvm-%EC%9D%B4%EB%9E%80-c142b01571f2
https://hoonmaro.tistory.com/19
책: 이것이 자바다
